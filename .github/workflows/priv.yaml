name: Check Privileged Environment

on:
  workflow_dispatch:

jobs:
  privileged-check:
    runs-on: ubuntu-24.04-ppc64le

    steps:
      - name: Check if environment is privileged
        shell: bash
        run: |
          set -euo pipefail

          echo "=== Checking for privileged environment ==="
          
          privileged=false
          
          echo "1) Attempting mount (tmpfs)"
          mkdir -p /tmp/priv-test
          if mount -t tmpfs tmpfs /tmp/priv-test 2>/dev/null; then
            echo "✔ Mount succeeded"
            umount /tmp/priv-test
            privileged=true
          else
            echo "✘ Mount failed"
          fi
          
          echo
          echo "2) Checking cgroup write access"
          if [ -w /sys/fs/cgroup ]; then
            echo "✔ /sys/fs/cgroup writable"
            privileged=true
          else
            echo "✘ /sys/fs/cgroup not writable"
          fi
          
          echo
          echo "=== Result ==="
          if [ "$privileged" = true ]; then
            echo "Environment is PRIVILEGED"
            exit 0
          else
            echo "Environment is UNPRIVILEGED"
            exit 1
          fi

          if capsh --print 2>/dev/null | grep -q cap_sys_admin; then
            echo "NOTE: CAP_SYS_ADMIN present but insufficient alone"
          fi



